name: Test Image

on:
  push:
    branches: [ test-dockerhub-limit ]

jobs:
  test:
    name: ${{matrix.runs-on}}
    strategy:
      fail-fast: false
      matrix:
        runs-on: [ubicloud-standard-2-ubuntu-2204, ubicloud-standard-2-ubuntu-2204, ubicloud-standard-2-ubuntu-2204]
    runs-on: ${{matrix.runs-on}}

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: docker info
        run: docker info

      - name: ip a
        run: ip a

      - name: Get IPv6 address
        run: curl -sL --ipv6 ifconfig.me

      - name: Check DockerHub limit without explicit IP stack
        run: |
          TOKEN=$(curl "https://auth.docker.io/token?service=registry.docker.io&scope=repository:ratelimitpreview/test:pull" | jq -r .token)
          curl --head -H "Authorization: Bearer $TOKEN" https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest

      - name: Check DockerHub limit with IPv6
        continue-on-error: true
        run: |
          TOKEN=$(curl "https://auth.docker.io/token?service=registry.docker.io&scope=repository:ratelimitpreview/test:pull" | jq -r .token)
          curl --ipv6 --head -H "Authorization: Bearer $TOKEN" https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest

      - name: Check DockerHub limit with IPv4
        run: |
          TOKEN=$(curl "https://auth.docker.io/token?service=registry.docker.io&scope=repository:ratelimitpreview/test:pull" | jq -r .token)
          curl --ipv4 --head -H "Authorization: Bearer $TOKEN" https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest

      - name: Pull a docker image
        run: docker pull postgres:15.4

      - name: Check DockerHub limit without explicit IP stack
        run: |
          TOKEN=$(curl "https://auth.docker.io/token?service=registry.docker.io&scope=repository:ratelimitpreview/test:pull" | jq -r .token)
          curl --head -H "Authorization: Bearer $TOKEN" https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest

      - name: Check DockerHub limit with IPv6
        continue-on-error: true
        run: |
          TOKEN=$(curl "https://auth.docker.io/token?service=registry.docker.io&scope=repository:ratelimitpreview/test:pull" | jq -r .token)
          curl --ipv6 --head -H "Authorization: Bearer $TOKEN" https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest

      - name: Check DockerHub limit with IPv4
        run: |
          TOKEN=$(curl "https://auth.docker.io/token?service=registry.docker.io&scope=repository:ratelimitpreview/test:pull" | jq -r .token)
          curl --ipv4 --head -H "Authorization: Bearer $TOKEN" https://registry-1.docker.io/v2/ratelimitpreview/test/manifests/latest
